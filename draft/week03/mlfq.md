# 다단계 피드백 큐(Multi-Level Feedback Queue)

이번 강의에서는 운영체제의 중요한 개념 중 하나인 다단계 피드백 큐(Multi-Level Feedback Queue, MLFQ)에 대해 알아보도록 하겠습니다. MLFQ는 프로세스의 과거 행동을 기반으로 미래의 CPU 사용량을 예측하여 스케줄링하는 알고리즘입니다.

MLFQ의 주요 목표는 짧은 작업을 먼저 실행하여 반환 시간을 최적화하고, 작업 길이에 대한 사전 지식 없이도 응답 시간을 최소화하는 것입니다. 이를 위해 MLFQ는 여러 개의 우선순위 큐를 사용하며, 각 큐는 서로 다른 시간 조각(Time slice)을 할당받습니다.

이번 강의에서는 MLFQ의 기본 규칙과 우선순위 조정 알고리즘에 대해 자세히 살펴볼 것입니다. 또한, MLFQ의 문제점과 이를 해결하기 위한 방법으로 우선순위 부스트(Priority Boost)와 개선된 규칙에 대해 설명드리겠습니다.

마지막으로, 실제 운영체제인 Solaris와 FreeBSD에서 MLFQ가 어떻게 구현되고 있는지 알아보고, MLFQ의 주요 내용을 요약하며 강의를 마무리하도록 하겠습니다.

## MLFQ 소개

다단계 피드백 큐(MLFQ)는 과거의 행동을 기반으로 미래를 예측하는 스케줄러입니다.

목표:

- 반환 시간 최적화: 짧은 작업을 먼저 실행
- 작업 길이에 대한 사전 지식 없이 응답 시간 최소화

## MLFQ 기본 규칙

1. MLFQ는 여러 개의 큐로 구성되며, 각 큐는 서로 다른 우선순위를 가집니다.
2. 실행 준비가 된 작업은 하나의 큐에만 위치합니다.
3. 우선순위가 높은 큐의 작업이 먼저 실행됩니다.
4. 같은 큐 내의 작업들은 라운드 로빈 방식으로 스케줄링됩니다.
5. MLFQ는 작업의 관찰된 행동에 따라 우선순위를 조정합니다.
   - 예: I/O를 기다리며 반복적으로 CPU를 양보하는 작업은 우선순위를 높게 유지
   - 예: 장시간 동안 CPU를 집중적으로 사용하는 작업은 우선순위를 낮춤

## MLFQ 우선순위 조정 알고리즘

- 규칙 3: 새로운 작업이 시스템에 진입하면, 가장 높은 우선순위 큐에 배치됩니다.
- 규칙 4a: 작업이 실행 중에 할당된 시간 조각을 모두 사용하면, 우선순위가 낮아집니다(즉, 아래 큐로 이동).
- 규칙 4b: 작업이 시간 조각을 다 사용하기 전에 CPU를 양보하면, 우선순위 수준은 유지됩니다.

## MLFQ 문제점

1. 기아(Starvation)

   - 시스템에 대화형 작업이 "너무 많으면", 장기 실행 작업은 CPU 시간을 받지 못할 수 있습니다.

2. 스케줄러 속이기

   - 시간 조각의 99%를 사용한 후, I/O 작업을 실행하면 작업이 CPU 시간의 더 높은 비율을 얻을 수 있습니다.

3. 프로그램의 행동이 시간에 따라 변할 수 있습니다.
   - CPU 집약적인 프로세스가 I/O 집약적으로 변할 수 있습니다.

## 우선순위 부스트(Priority Boost)

- 규칙 5: 일정 시간(S) 후에, 시스템의 모든 작업을 최상위 큐로 이동시킵니다.

## 개선된 규칙

- 규칙 4 (규칙 4a와 4b 통합): 작업이 주어진 수준에서 할당된 시간을 모두 사용하면(CPU를 양보한 횟수에 관계없이), 우선순위가 낮아집니다(즉, 아래 큐로 이동).

## MLFQ 튜닝 및 기타 이슈

- 높은 우선순위 큐: 짧은 시간 조각(예: 10ms 이하)
- 낮은 우선순위 큐: 긴 시간 조각(예: 100ms)

## Solaris와 FreeBSD의 MLFQ 구현

Solaris:

- 60개의 큐
- 점진적으로 증가하는 시간 조각 길이
- 최고 우선순위: 20ms
- 최저 우선순위: 수백 ms
- 약 1초마다 우선순위 부스트

FreeBSD:

- 큐 없이 공식 사용
- CPU 사용량에 따라 프로세스의 우선순위 계산
- 감쇠(Decay)를 통해 우선순위 부스트
- 사용자 조언(Nice) 고려
- 효율성을 위해 큐 사용

## MLFQ 요약

- MLFQ는 프로세스의 CPU 사용량에 대한 사전 지식 없이도 효과적으로 동작하는 스케줄링 알고리즘입니다.
- 과거 행동을 기반으로 우선순위를 조정하여 반환 시간과 응답 시간을 최적화합니다.
- 우선순위 부스트와 개선된 규칙을 통해 기아 현상과 스케줄러 속이기 문제를 해결할 수 있습니다.
